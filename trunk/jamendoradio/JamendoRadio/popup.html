<html>
<head>
    <style type="text/css">
		body { overflow:hidden; }
        table { white-space: nowrap; } td { vertical-align:top; max-width:315px; overflow:hidden;}
        a { margin-right: 10px; cursor:hand; text-decoration:underline;color:#999; display:inline; }
        #stationContainer { text-align:center;  }
        #controls { vertical-align: top; float: right; }
        #controls a { width: 16px; display:block; height: 16px; margin-bottom:5px; text-decoration:none!important; }
        #play { background: url(Images/control_pause.png) no-repeat; }
        #stop { background: url(Images/control_stop.png) no-repeat; }
        #next { background: url(Images/control_fastforward.png) no-repeat; }
		#volume { cursor:hand; }
        .paused { background: url(Images/control_play.png) no-repeat !important; }
        .disabled { display:none; }
        .empty { cursor:auto!important; text-decoration:none!important; }
    </style>
	<script src="jquery.js" />
    <script type="text/javascript">
        var bp = chrome.extension.getBackgroundPage();
        bp.OnPositionChanged = loadPlayerInfo;
        bp.OnImageLoaded = setImage;
		 
        function main() {
			var skipDefault = eval(localStorage["SkipDefault"]);
			if(!skipDefault)		
				stations.appendChild(getStationLink("Default", ""));

            var storedStations = eval(localStorage["Stations"]);
            if (storedStations) {
                for (i = 0; i < storedStations.length; i++) {
					var updatedSubset = UpdateSubset(storedStations[i].Subset);
                    stations.appendChild(getStationLink(storedStations[i].Name, updatedSubset));
					storedStations[i].Subset = updatedSubset;
                }
            }
			localStorage["Stations"] = JSON.stringify(storedStations);
			
            loadPlayerInfo();
         }
		 function UpdateSubset(subset)
		 {
			if(subset.indexOf("/?") > -1) return subset;
			var rxConfig = /[?&]?(\w+)=([\w+.]+)/g;
			
			var joins = "";
			var config = "";
			
			var setting = rxConfig.exec(subset);
			
			while(setting) 
			{ 
				if(setting[1] == "tag_idstr")
					joins += "+album_tag/";
					
				if(!config) config += "?" + setting[1] + "=" + setting[2];
				else config += "&" + setting[1] + "=" + setting[2];
							
				setting = rxConfig.exec(subset);
			}
			
			if(!joins) joins = "/";
			return joins + config;
		 }
		 
		 
		 
		function animateLeft(elementName) {
			var distance = $(elementName).width() - 315;
			setTimeout(function() {
			$(elementName).animate({ marginLeft: distance * -1 }, 2000, "", function() { animateRight(elementName); }); }, 1000);
		}
		function animateRight(elementName) {
			var distance = $(elementName).width() - 315;
			setTimeout(function() {
			$(elementName).animate({ marginLeft: 0 }, 2000, "", function() { if($(elementName).width() > 315) animateLeft(elementName); }); }, 550);
		}
        function loadPlayerInfo() {
			setImage();
			            
            $("#name").html(bp.CurrentData.name).stop().css("margin-left", "0");
			$("#artist_name").html(bp.CurrentData.artist_name).stop(true).css("margin-left", "0").toggleClass("empty", !bp.IsReady);            
			$("#album_name").html(bp.CurrentData.album_name).stop(true).css("margin-left", "0").toggleClass("empty", !bp.IsReady);
			
			$("#play").toggleClass("paused", !bp.IsPlaying);
			
			if($("#name").width() > 315) animateLeft("#name");
			if($("#artist_name").width() > 315) animateLeft("#artist_name");
			if($("#album_name").width() > 315) animateLeft("#album_name");
			
            if (bp.CurrentData.album_url)
                $("#album_name").click(function() { chrome.tabs.create({ "url": bp.CurrentData.album_url }); });
            else
                $("#album_name").click(function() { });

			if (bp.CurrentData.artist_url)
                $("#artist_name").click(function() { chrome.tabs.create({ "url": bp.CurrentData.artist_url }); });
            else
                $("#artist_name").click(function() { });
				
            if (bp.IsReady) {
				$("#controls").show();
				
				var knob = document.getElementById("volumeknob"); var slide = document.getElementById("volume"); 
				knob.style.top = slide.offsetHeight - (bp.volume * slide.offsetHeight) + "px";
            }
            else {
				$("#controls").hide();
            }
			
			if($("body").width() > $("table").width())
				$("table").width($("body").width());
			else
				$("table").width("auto");
		}
		
		function setImage() {
            if (bp.AlbumImageLoaded && $("#image").attr("src") != bp.CurrentData.album_image)
				$("#image").fadeOut("slow", function() { $("#image").attr("src", bp.CurrentData.album_image).fadeIn("fast"); });
            else {
                $("#image").fadeOut("slow");
				$("body").css("width", "auto");
			}
        }

        function PlayPause(element) {
            bp.Pause(element);
        }
        function Stop(element) {
            bp.Unload();
        }
        function Next(element) {
             bp.Next();
        }
        
		function LoadStation(subset) {
			bp.PopulatePlaylist(subset, true, bp.Play, false);
        }

        function getStationLink(name, subset) {
            var radio = document.createElement("a");
            radio.onclick = function() { LoadStation(subset); };
            radio.innerText = name;

            return radio;
        }
		
		function SetVolume(element) {
			var knob = document.getElementById("volumeknob"); var slide = document.getElementById("volume");
			
			var offset = event.offsetY;
			if(event.srcElement == knob)
				offset += parseInt(knob.style.top);
				
			var volume = (slide.offsetHeight - offset) / slide.offsetHeight;
					
			knob.style.top = offset + "px";
			bp.setVolume(volume);
		}
				
		$(document).ready(function(){
			main();
		});
    </script>
</head>
<body>
    <table cellspacing="0" cellpadding="0" id="player">
        <tr>
            <td id="container" rowspan="3" style="width:105px;">
                <div style="height:100px;background:url('Images/ajax-loader.gif') no-repeat 25px 15px;">
                    <img id="image" alt="" src="" />&nbsp;
                </div>
            </td>
            <td><div id="name" style="font-size: 1.5em;color:#135ABB;display:inline;"></div>
            </td>
			<td rowspan="4" style="min-width:16px;">
				<div id="controls" class="disabled">
					<a id="play" class="paused" onclick="PlayPause(this);">&nbsp;</a>
					<a id="stop" onclick="Stop(this);">&nbsp;</a>
					<a id="next" onclick="Next(this);">&nbsp;</a>
					<div id="volume" onmousedown="SetVolume(this);" style="background:url(Images/volume_bg.png) repeat-y;width:16px;height:50px;">
						<img id="volumeknob" src="Images/control_volume.png" style="position:relative;top:25px;" />
					</div>
				</div>
				&nbsp;				
			</td>
        </tr>
        <tr>
            <td>
                <a id="album_name" class="empty"></a></td>
        </tr>
        <tr>
            <td>
                <a id="artist_name" class="empty"></a></td>
        </tr>
		<tr>
			<td colspan="3">
				<hr style="width: 75%; color:#aaa;" />
				<div id="stationContainer"><span id="stations" /></div>
				<div id="slider"></div>
			</td>
		</tr>
    </table>
</body>
</html>
