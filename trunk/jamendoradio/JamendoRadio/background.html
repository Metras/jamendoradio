<script>
    //State variables
    var IsPlaying;
    var IsReady;
    var CurrentData;
    var CurrentPosition;
    var AlbumImageLoaded;

    //Position changed callback (this updates the gui in popup.html)
    var OnPositionChanged;
    var OnImageLoaded;

    //Internals
    var audio = new Audio();
    var playList;
    var currentSubset;
	var loop;
	var timeKeeper;
	var volume = 1;

    //Check if the current song has ended, and advance playlist to next item if that is the case.
    setInterval(function() { if (IsPlaying && audio.ended) Next(); }, 250);

    chrome.extension.onRequest.addListener(function (request, sender, sendResponse) {
        if (request.target) {
            switch (request.target) {
                case "manipulatePage": sendResponse({ GoAhead: eval(localStorage["SiteIntegration"]) }); return;
                case "loadAlbumPlayList": LoadAlbum(request.data); break;
                case "loadTrackPlayList": LoadTrack(request.data); break;
                case "loadArtistRadio": LoadArtist(request.data); break;
                case "loadPlayList": LoadPlayList(request.data); break;
                case "loadRadioPlayList": LoadRadio(request.data); break;
            }
            sendResponse();
        }
        else
            sendResponse({});
    });
    var test = "nej";
    chrome.browserAction.onClicked.addListener(function (tab) {
        test = "ja";
    });

    function LoadPlayListObject(subset, callBack, preLoad, config) {
		//this is the url base. It defines the address, what fields, the base unit and the return format. These are mandatory for the proper operation of the extension.
        var url = "http://api.jamendo.com/get2/name+stream+album_name+album_url+album_image+artist_name+artist_url/track/json/";

        //We need to store the criteria globally, to enable prefetching playlist items.
        if (!preLoad && !subset)
            currentSubset = "order=ratingmonth_desc"; //By default, pick songs from this months most popular.
        else if (!preLoad)
            currentSubset = subset;
		
		//Now lets build the query. First lets see if we have gotten a custom configuration...
        if (!config) {
            loop = false; //We haven't. Set the extension to normal Radio behaviour. Then add joins and options, depending on whether the query uses albums, tags or artists or nothing, as base criteria.
            if (currentSubset.indexOf('album_id') > -1 || currentSubset.indexOf('artist_idstr') > -1 || currentSubset.indexOf('artist_id') > -1)
                url += "track_album+album_artist/?n=5&order=random&streamencoding=ogg2&";
            else
                url += "track_album+album_tag+album_artist/?n=5&nshuffle=500&streamencoding=ogg2&"; 
        }
        else { 
			loop = true; //We have a custom configuration. The play list will not be re-loaded, but only looped when the end is reached.
			url += config; 
		}

		//And lastly, lets append the actual criteria.
        url += currentSubset;

        if (timeKeeper) return; //ignore spamming, conforms to Jamendo API terms of use.
        timeKeeper = true;
        var req = new XMLHttpRequest();
        
		req.open("GET", url, true);
		req.onload = function () {
		    playList = eval(req.responseText);
		    setTimeout(function () { timeKeeper = false; }, 1100); //Release the timeKeeper
            
		    if (playList.length < 1) { alert('Criteria yilded no songs!'); return; }
		    IsReady = true;

		    if (!preLoad) SetPlaylistPosition(0);
		    if (callBack) callBack(playList);
		};
        req.send(null);
    }

	function LoadAlbum(id) 	{
	    LoadPlayListObject("album_id=" + id, Play, false, "track_album+album_artist/?streamencoding=ogg2&order=numalbum_asc&");
	}
	function LoadTrack(id) {
		LoadPlayListObject("id=" + id, Play, false, "track_album+album_artist/?streamencoding=ogg2&");
	}
	function LoadArtist(name) {
		LoadPlayListObject("artist_idstr=" + name, Play);
	}
    function LoadRadio(id) {
        LoadPlayListObject("radio_id=" + id, Play, false, "track_album+album_artist+radio_track_inradioplaylist/order=numradio_asc&");
    }
    function LoadPlayList(id) {
        LoadPlayListObject("playlist_id=" + id, Play, false, "track_album+album_artist+playlist_track/?streamencoding=ogg2&order=numplaylist_asc&");
    }
	
    function SetPlaylistPosition(position) {
        CurrentPosition = position; CurrentData = playList[CurrentPosition];
        
        if (CurrentPosition >= (playList.length - 1)) { //Last song in playlist.
            CurrentPosition = -1;
            if (!loop) LoadPlayListObject(null, null, true) //If not looping a fixed playlist, prefetch new songs from jamendo.
        }
		
		if(CurrentData) {
		    audio.src = CurrentData.stream;
		    audio.volume = 1;
			audio.load();
			AlbumImageLoaded = false;
			if (OnPositionChanged) OnPositionChanged(CurrentData);
            var albumImage = document.createElement("img");
            albumImage.onload = function () { AlbumImageLoaded = true; if (OnImageLoaded) OnImageLoaded(); }
			albumImage.src = CurrentData.album_image;
		}
		else Unload();
    }
	
    function Play() {
        if (IsReady) {
            audio.play();
            if (volume) audio.volume = volume;
            IsPlaying = true;
        }
    }

    //Toggles play pause, and can update a passed along elements css class.
    function Pause(element) {
        if (IsReady) {
            if (audio.paused)
                Play();
            else {
                audio.pause(); 
                IsPlaying = false;
            }

            if (element) {
                if (audio.paused)
                    element.className = "paused";
                else
                    element.className = "";
            }
        }
    }

    //Loads the next song.
    function Next() {
        if (IsReady) {
            var wp = IsPlaying;
            SetPlaylistPosition(CurrentPosition + 1);
            if (wp) Play();
        }
    }

	//Set volume
	function setVolume(value) {
	    audio.volume = value;
	    volume = value;
	}

	
    //Stops playing and remove current playlist.
    function Unload() {
        audio.src = "";
        audio.load();
        playList = null;
        IsReady = false;
        IsPlaying = false;
        CurrentData = { "name": "No radio loaded", "album_name": "Please select a", "artist_name": "channel below...", "album_image": "Images/splash.jpg" };
        CurrentPosition = -1;

        AlbumImageLoaded = true;

        if (OnPositionChanged)
            OnPositionChanged(CurrentData);
    }
    Unload();
</script>

